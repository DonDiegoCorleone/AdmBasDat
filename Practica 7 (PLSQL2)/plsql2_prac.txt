create or replace PACKAGE BODY PK_ASIGNACION_GRUPOS AS
PROCEDURE PR_ASIGNA_ASIGNADOS IS

CURSOR c_nuevo_ingreso IS SELECT A.GRUPOS_ASIGNADOS,A.NEXPEDIENTE FROM ALUMNOS_EXT A where regexp_like (grupos_asignados,'[A-Z]');
JOIN
NUEVO_INGRESO P ON A.DNI=P.DOCUMENTO;
TITULACION VARCHAR2(200);
CURSOR c_asignaturas IS SELECT CODIGO,GRUPO FROM TEMP_ASIGNATURAS;
LETRA BOOLEAN;
P NUMBER;
GUION NUMBER;
CONT NUMBER;
I NUMBER;
COD NUMBER;
ID_GRUPO VARCHAR2(100);

BEGIN
I:=1;
LETRA:=TRUE;

FOR varAlumno in c_nuevo_ingreso loop

TITULACION:=SUBSTR(varAlumno.nexpediente,1,4);

NORMALIZA_ASIGNATURAS(varAlumno.grupos_asignados,TITULACION);

FOR varAsignaturas in c_asignaturas loop

IF varAsignaturas.grupo is NULL THEN
INSERT INTO ERRORES VALUES (sysdate,'Asignatura sin grupo',varAsignaturas.codigo,CURSO_ACTUAL(),null,null,varAlumno.nexpediente,TITULACION);
ELSE
SELECT REFERENCIA INTO ASIG_REF FROM ASIGNATURA WHERE CODIGO=varAsignaturas.codigo;
UPDATE ASIGNATURAS_MATRICULA SET GRUPO_ID=varAsignaturas.grupo WHERE ASIGNATURA_REFERENCIA=ASIG_REF AND MATRICULA_EXPEDIENTE=varAlumno.nexpediente;

END IF;

END LOOP;

end loop;

END;
END PK_ASIGNACION_GRUPOS;
