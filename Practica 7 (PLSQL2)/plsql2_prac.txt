create or replace PACKAGE BODY PK_ASIGNACION_GRUPOS AS
PROCEDURE PR_ASIGNA_ASIGNADOS IS

CURSOR c_nuevo_ingreso IS SELECT A.GRUPOS_ASIGNADOS,A.NEXPEDIENTE FROM ALUMNOS_EXT A where regexp_like (grupos_asignados,'[A-Z]');
JOIN
NUEVO_INGRESO P ON A.DNI=P.DOCUMENTO;
TITULACION VARCHAR2(200);
LETRA BOOLEAN;
P NUMBER;
GUION NUMBER;
CONT NUMBER;
I NUMBER;
COD NUMBER;
ID_GRUPO VARCHAR2(100);

BEGIN
I:=1;
LETRA:=TRUE;

FOR varAlumno in c_nuevo_ingreso loop
GUION:=INSTR(varAlumno.grupos_asignados,'-');
WHILE GUION!=0 LOOP

IF(SUBSTR(varAlumno.grupos_asignados,GUION+1,GUION+1) = ',') THEN
LETRA:=FALSE;
END IF;

GUION:=INSTR(varAlumno.grupos_asignados,'-',GUION+1);

END LOOP;
TITULACION:=SUBSTR(varAlumno.nexpediente,1,4);

IF LETRA=FALSE THEN
INSERT INTO ERRORES VALUES (sysdate,'Asignaturas sin grupos',null,null,null,null,varAlumno.nexpediente,TITULACION);
END IF;

IF LETRA=TRUE THEN

NORMALIZA_ASIGNATURAS(varAlumno.grupos_asignados,TITULACION);

SELECT COUNT(*) INTO CONT FROM TEMP_ASIGNATURAS;

WHILE COUNT>0 LOOP --HACER BUCLE
SELECT CODIGO INTO COD FROM TEM_ASIGNATURAS WHERE ROWNUM=I;
SELECT GRUPO INTO ID_GRUPO FROM TEM_ASIGNATURAS WHERE ROWNUM=I;
SELECT REFERENCIA INTO ASIG_REF FROM ASIGNATURA WHERE CODIGO=COD;
UPDATE ASIGNATURAS_MATRICULA SET GRUPO_ID=ID_GRUPO WHERE ASIGNATURA_REFERENCIA=ASIG_REF AND MATRICULA_EXPEDIENTE=varAlumno.nexpediente;
END LOOP;

END IF;

end loop;

END;
END PK_ASIGNACION_GRUPOS;

select DOCUMENTO from alumnos_ext WHERE ROWNUM=1;
